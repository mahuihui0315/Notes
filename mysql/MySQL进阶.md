# MySQL进阶

## 基础架构：一条SQL查询语句的执行流程

### 连接器

+ 连接器负责跟客户端建立连接、获取权限、维持和管理连接

#### 长连接

+ 长连接是指连接成功后，如果客户端持续有请求，则一直使用同一个连接
+ 消耗内存较多，占用的资源直到关闭连接才会释放
+ 解决方法：
   + 关闭连接并重新建立
   + 使用mysql_reset_connection，初始化连接
#### 短链接
+ 每次执行完很少的查询就断开连接，下次查询重新建立连接

### 查询缓存

+ 每次进行查询之后结果会保存到查询缓存中，下次查询若在缓存中存在就直接返回
+ 每次更新会重新加载缓存，实际效率比较低
+ MySQL8.0以后删除了该功能

### 分析器

+ 检查输入语法格式是否正确
+ 以及查询条件是否有误，例如查询不存在的列

### 优化器

+ 对将要执行的语句选择合适的执行方式

### 执行器

+ 判断是否有对该表的操作权限
+ 若有权限，开始查询
   1. 调用 InnoDB 引擎接口取这个表的第一行，判断是否满足查询条件，满足则存入结果集
   ，不是则跳过
   2. 调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行
   3. 执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端

## 日志系统：一条SQL更新语句的执行流程
+ 更新流程涉及两个重要的日志模块
   1. redo log
   2. binlog
   
### redo log
+ InnoDB数据库持有
+ 当有一条记录需要更新时，InnoDB会先把记录写到redo log中，等到操作不忙时，在写进磁盘中。
+ InnoDB 的 redo log 是固定大小的，从头开始写，写到末尾就又回到开头循环写，当write point
赶上check point时表明redo log用完，需要清除一些记录   
+ 因为redo log的存在，即使数据库发生重启，之前的数据也不会丢失

### binlog
+ binlog为MySQL的server层实现的，所有引擎都可以使用
+ redo log为物理日志，记录了修改内容，而binlog为逻辑日记，记录了修改的原始逻辑
+ binlog为追加写入，文件达到一定大小时，切换下一个

### update的执行流程
1. 根据条件查询记录
2. 数据不在内存中则从磁盘读取，在就返回数据
3. 执行update内容
4. 写入更新到内存中
5. 写入redolog，处于prepare状态
6. 写binlog
7. 提交事务，redolog处于commit状态

### 事务的使用
+ 使用事务进行两阶段提交，是为了使两份数据的状态保持一致
+ 若数据不一致则会在，导出binlog进行数据恢复时出现状态不一致导致数据丢失

## 事务隔离

### 事务特性
+ 原子性：Automicity
+ 一致性：Consistency
+ 隔离性：Isolation
+ 持久性：Durability

### 隔离级别
+ 读未提交：read uncommiteed
+ 读已提交：read committed
+ 可重复读：repeatable read
+ 串行化：serializable

### 回滚操作
+ 假设一个值从1开始，按顺序改为了2,3,4，则在回滚日志中会有不同的read-view和不同时间
查询该值的事务所对应，同一条记录在系统中可以存在多个版本，就是数据库的多版本并发控制
+ 当系统中没有比回滚日志更早的read-view时，回滚日志就会被删除

### 事务的启动方式
+ 显示启动
   1. start transaction
   2. commit
   3. rollback
+ set autocommit=0
> 关闭自动提交从执行语句，开始事务，直到commit或rollback，或断开连接

因为长事务会占用大量资源及存储空间，因此尽量使用自动提交，并显示的开启事务；
若重复开启提交事务操作繁琐可使用commit work and chain，提并开启新事物